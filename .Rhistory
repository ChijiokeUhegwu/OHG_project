geom_col(show.legend = FALSE) +
facet_wrap(~isolation_source, scales = "free_x") +
labs(x = "Count",
y = "Drug Class") +
scale_fill_viridis_d(option = "D") +
theme_bw() +
theme(panel.grid = element_blank(),
plot.title = element_text(size = 12, face = "bold", hjust = 0.2)
)
# 5. Drug class dominance by country
geo_drug <- resfinder_fulldata %>%
distinct(sample_id, location, drug_class_group) %>%
count(location, drug_class_group)
# Visualization
geo_drug_plot <-
ggplot(geo_drug, aes(x = n, y = reorder(drug_class_group, n), fill = drug_class_group)) +
geom_col(show.legend = FALSE) +
facet_wrap(~location, scales = "free_x") +
labs(x = "Count",
y = "Drug Class") +
scale_fill_viridis_d(option = "D") +
theme_bw() +
theme(panel.grid = element_blank(),
plot.title = element_text(size = 12, face = "bold", hjust = 0.2)
)
# 6. Country × drug class heatmap
# Create wide matrix
geo_heat <- geo_drug %>%
pivot_wider(names_from = drug_class_group,
values_from = n,
values_fill = 0)
geo_matrix <- geo_heat %>%
column_to_rownames("location") %>%
as.matrix()
# Row scaling (equivalent to scale = "row")
geo_matrix_scaled <- t(scale(t(geo_matrix)))
# Apply clustering (to mimic pheatmap ordering)
row_order <- hclust(dist(geo_matrix_scaled))$order
col_order <- hclust(dist(t(geo_matrix_scaled)))$order
geo_matrix_scaled <- geo_matrix_scaled[row_order, col_order]
# convert back to long format
geo_heat_long <- as.data.frame(geo_matrix_scaled) %>%
rownames_to_column("location") %>%
pivot_longer(-location,
names_to = "drug_class",
values_to = "scaled_count")
# plot with ggplot
geo_heat_plot <- ggplot(geo_heat_long,
aes(x = drug_class,
y = location,
fill = scaled_count)) +
geom_tile(color = "white") +
scale_fill_gradient2(
low = "navy",
mid = "white",
high = "firebrick",
midpoint = 0) +
labs(x = "Drug Class",
y = "Country",
fill = "Scale") +
theme_minimal(base_size = 12) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
panel.grid = element_blank()
)
# 7. Country × resistance genes heatmap
# Create wide matrix
top_countries <- resfinder_fulldata %>%
count(location, gene, sort = TRUE) %>%
slice_head(n = 15) %>%
pivot_wider(names_from = gene,
values_from = n,
values_fill = 0)
gene_matrix <- top_countries %>%
column_to_rownames("location") %>%
as.matrix()
# Row scaling (equivalent to scale = "row")
gene_matrix_scaled <- t(scale(t(gene_matrix)))
# Apply clustering
row_order_gene <- hclust(dist(gene_matrix_scaled))$order
col_order_gene <- hclust(dist(t(gene_matrix_scaled)))$order
gene_matrix_scaled <- gene_matrix_scaled[row_order_gene, col_order_gene]
# convert back to long format
gene_heat_long <- as.data.frame(gene_matrix_scaled) %>%
rownames_to_column("location") %>%
pivot_longer(-location,
names_to = "gene",
values_to = "scaled_count")
# plot with ggplot
top_countries_plot <- ggplot(gene_heat_long,
aes(x = gene,
y = location,
fill = scaled_count)) +
geom_tile(color = "white") +
scale_fill_gradient2(
low = "navy",
mid = "white",
high = "firebrick",
midpoint = 0) +
labs(x = "Resistance Gene",
y = "Country",
fill = "Scale") +
theme_minimal(base_size = 12) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
panel.grid = element_blank()
)
# 8. Trends in resistance burden over time
time_trend <- resfinder_fulldata  %>%
distinct(sample_id, collection_year, drug_class_group) %>%
count(collection_year, drug_class_group)
# Visualization
time_trend_plot <-
ggplot(time_trend, aes(x = collection_year, y = n, color = drug_class_group)) +
geom_line() +
geom_point() +
labs(
x = "Year of collection",
y = "Resistance determinant count",
color = "Drug class group"
) +
scale_color_viridis_d(option = "D") + # to modify the aes color for consistency
theme_minimal() +
theme(panel.grid = element_blank(),
plot.title = element_text(size = 12, face = "bold", hjust = 0.2)
)
# 9. # Dashboard summary metrics
total_isolates <- resfinder_fulldata %>%
distinct(sample_id) %>%
nrow()
total_genes <- resfinder_fulldata %>%
distinct(gene) %>%
nrow()
total_countries <- resfinder_fulldata %>%
distinct(location) %>%
nrow()
coverage_df <- tibble(
country = c("Argentina","Brazil","New Zealand","China","France",
"Germany","Nigeria","United Kingdom","United States"),
isolates = c(4, 6, 10, 20, 5, 5, 20, 10, 20)
)
# Generate 9 distinct colors
country_colors <- brewer.pal(9, "Set1")
coverage_map_plotly <- plot_geo()
for (i in seq_len(nrow(coverage_df))) {
coverage_map_plotly <- coverage_map_plotly %>%
add_trace(
data = coverage_df[i, ],
locations = ~country,
locationmode = "country names",
z = 1,
type = "choropleth",
name = coverage_df$country[i],  # This creates legend entry
colorscale = list(c(0, country_colors[i]),
c(1, country_colors[i])),
showscale = FALSE,
hovertemplate = paste0(
"<b>", coverage_df$country[i], "</b><br>",
"Isolates: ", coverage_df$isolates[i],
"<extra></extra>"
)
)
}
coverage_map_plotly <- coverage_map_plotly %>%
layout(
geo = list(
showframe = FALSE,
showcoastlines = TRUE,
projection = list(type = "equirectangular")
),
legend = list(title = list(text = "<b>Countries</b>")),
margin = list(l = 0, r = 0, t = 50, b = 0)
)
coverage_map_plotly
value_box(
title = "Total Isolates",
value = total_isolates,
showcase = bsicons::bs_icon("database"),
theme = "primary"
)
value_box(
title = "Unique AMR Genes Detected",
value = total_genes,
showcase = bsicons::bs_icon("shield-lock"),
theme = "danger"
)
value_box(
title = "Countries Represented",
value = total_countries,
showcase = bsicons::bs_icon("globe"),
theme = "success"
)
ggplotly (amr_presence_plot)
ggplotly (top_genes_plot)
ggplotly(geo_drug_plot)
ggplotly(drug_long_plot)
ggplotly(geo_heat_plot)
ggplotly(top_countries_plot)
ggplotly(time_trend_plot)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
# Load packages
pacman::p_load(
janitor, # data analysis utilities
here, # force rmds to use the project folder as working directory
tidyverse, # for everything!
dlookr, # to check for missing values
gt, # for tables display
scales, # for formatting numbers
plotly, # for plot interactivity
RColorBrewer,
pheatmap # for heatmap
)
# Import the data
resfinder_fulldata <- read_csv(here("outputs/resfinder_fulldata.csv"))
amr_presence <- resfinder_fulldata %>%
distinct(sample_id, isolation_source) %>%
count(isolation_source, name = "n_isolates")
# Visualization
amr_presence_plot <- amr_presence %>%
ggplot(aes(x = fct_reorder(isolation_source, desc(n_isolates)), y = n_isolates)) +
geom_col(fill = "steelblue") +
labs(
title = "Figure 1: Distribution of AMR-positive isolates by isolation source",
x = "Isolates",
y = "Number of Isolates"
) +
theme_minimal() +
theme(panel.grid = element_blank(),
plot.title = element_text(size = 12, face = "bold", hjust = 0.2)
)
amr_presence_plot
amr_burden <- resfinder_fulldata %>%
distinct(sample_id, gene, isolation_source) %>%
count(sample_id, isolation_source, name = "gene_count")
# Visualization
amr_burden_plot <-
ggplot(amr_burden, aes(x = fct_reorder(isolation_source, desc(gene_count)), y = gene_count, fill = isolation_source)) +
geom_boxplot(outlier.shape = NA, alpha = 0.6) +
geom_jitter(width = 0.2, alpha = 0.3, size = 1) +
labs(
x = "Isolation source",
y = "Number of AMR genes per isolate",
title = "Figure 2: AMR gene burden across sources",
fill = "Isolation source"
) +
theme_minimal() +
theme(panel.grid = element_blank(),
plot.title = element_text(size = 12, face = "bold", hjust = 0.2),
legend.position = "none" # to remove the legend showing the color labels
)
amr_burden_plot
top_genes <- resfinder_fulldata %>%
count(gene, sort = TRUE) %>%
slice_head(n = 15)
# Visualization of top genes
top_genes_plot <-
ggplot(top_genes, aes(x = reorder(gene, n), y = n)) +
geom_col(fill = "steelblue") +
coord_flip() +
labs(
x = "AMR gene",
y = "Frequency",
title = "Figure 3: Top AMR genes detected across isolates"
) +
theme_minimal() +
theme(panel.grid = element_blank(),
plot.title = element_text(size = 12, face = "bold", hjust = 0.2)
)
top_genes_plot
# Preferred transformation and plot
drug_long <- resfinder_fulldata %>%
count(isolation_source, drug_class_group)
# Visualization
drug_long_plot <-
ggplot(drug_long, aes(x = n, y = reorder(drug_class_group, n), fill = drug_class_group)) +
geom_col(show.legend = FALSE) +
facet_wrap(~isolation_source, scales = "free_x") +
labs(x = "Count",
y = "Drug Class",
title = "Figure 4: Distribution of Antimicrobial Classes Across One Health Sources") +
scale_fill_viridis_d(option = "D") +
theme_bw() +
theme(panel.grid = element_blank(),
plot.title = element_text(size = 12, face = "bold", hjust = 0.2)
)
drug_long_plot
geo_drug <- resfinder_fulldata %>%
distinct(sample_id, location, drug_class_group) %>%
count(location, drug_class_group)
# Visualization
geo_drug_plot <-
ggplot(geo_drug, aes(x = n, y = reorder(drug_class_group, n), fill = drug_class_group)) +
geom_col(show.legend = FALSE) +
facet_wrap(~location, scales = "free_x") +
labs(x = "Count",
y = "Drug Class",
title = "Figure 5: Country-Level Dominance of Antimicrobial Classes") +
scale_fill_viridis_d(option = "D") +
theme_bw() +
theme(panel.grid = element_blank(),
plot.title = element_text(size = 12, face = "bold", hjust = 0.2)
)
geo_drug_plot
geo_heat <- geo_drug %>%
pivot_wider(names_from = drug_class_group, values_from = n, values_fill = 0)
geo_heat_plot <-
pheatmap(
geo_heat %>% column_to_rownames("location"),
scale = "row",
clustering_distance_rows = "euclidean",
clustering_distance_cols = "euclidean",
main = "Figure 6: Heatmap of resistance classes by country"
)
geo_heat_plot
top_countries <- resfinder_fulldata %>%
count(location, gene, sort = TRUE) %>%
slice_head(n = 15) %>%
pivot_wider(names_from = gene, values_from = n, values_fill = 0)
top_countries_plot <-
pheatmap(
top_countries %>% column_to_rownames("location"),
scale = "row",
clustering_distance_rows = "euclidean",
clustering_distance_cols = "euclidean",
main = "Figure 7: Heatmap of resistance genes by country"
)
top_countries_plot
# Instead of plotting the raw year counts, it is best to normalize the data by number of isolates per year to account for where the sampling differs by year.
time_trend <- resfinder_fulldata  %>%
distinct(sample_id, collection_year, drug_class_group) %>%
count(collection_year, drug_class_group)
# Visualization
time_trend_plot <-
ggplot(time_trend, aes(x = collection_year, y = n, color = drug_class_group)) +
geom_line() +
geom_point() +
labs(
x = "Year of collection",
y = "Resistance determinant count",
title = "Figure 8: Temporal trends in antimicrobial resistance classes",
color = "Drug class group"
) +
scale_color_viridis_d(option = "D") + # to modify the aes color for consistency
theme_light() +
theme(panel.grid = element_blank(),
plot.title = element_text(size = 12, face = "bold", hjust = 0.2)
)
time_trend_plot
ggplotly (amr_burden_plot)
top_gene_list <- resfinder_fulldata %>%
count(gene, sort = TRUE) %>%
slice_head(n = 5) %>%
pull(gene)
# count those genes per year
top_genes_year <- resfinder_fulldata %>%
filter(gene %in% top_gene_list) %>%
count(collection_year, gene)
# visualize top genes
top_genes_trend_plot <-
ggplot(top_genes_year,
aes(x = collection_year,
y = n,
color = gene,
group = gene)) +
geom_line(size = 1) +
geom_point(size = 2) +
labs(
x = "Year of collection",
y = "Number of detections",
color = "AMR Gene"
) +
scale_color_viridis_d(option = "D") +
theme_minimal() +
theme(
panel.grid = element_blank(),
axis.text.x = element_text(angle = 45, hjust = 1),
plot.title = element_text(size = 12, face = "bold")
)
top_genes_trend_plot
top_gene_list
# Identify top 5 (or 10) genes overall
top_gene_list <- resfinder_fulldata %>%
count(gene, sort = TRUE) %>%
slice_head(n = 5) %>%
pull(gene)
# count those genes per year
top_genes_year <- resfinder_fulldata %>%
filter(gene %in% top_gene_list) %>%
count(collection_year, gene)
# visualize top genes
top_genes_trend_plot <-
ggplot(top_genes_year,
aes(x = collection_year,
y = n,
color = gene,
group = gene)) +
geom_line(size = 1) +
geom_point(size = 2) +
labs(
x = "Year of collection",
y = "Number of detections",
color = "AMR Gene"
) +
scale_color_viridis_d(option = "D") +
theme_minimal() +
theme(
panel.grid = element_blank(),
axis.text.x = element_text(angle = 45, hjust = 1),
plot.title = element_text(size = 12, face = "bold")
)
top_genes_trend_plot
# Identify top 5 (or 10) genes overall
top_gene_list <- resfinder_fulldata %>%
count(gene, sort = TRUE) %>%
slice_head(n = 5) %>%
pull(gene)
# count those genes per year
top_genes_year <- resfinder_fulldata %>%
filter(gene %in% top_gene_list) %>%
count(collection_year, gene)
# visualize top genes
top_genes_trend_plot <-
ggplot(top_genes_year,
aes(x = collection_year,
y = n)) +
geom_line(color = "#2C7BB6") +
geom_point(color = "#2C7BB6") +
facet_wrap(~ gene, scales = "free_y") +
theme_minimal() +
labs(
x = "Year of collection",
y = "Number of detections",
color = "AMR Gene"
) +
scale_color_viridis_d(option = "D") +
theme_minimal() +
theme(
panel.grid = element_blank(),
axis.text.x = element_text(angle = 45, hjust = 1),
plot.title = element_text(size = 12, face = "bold")
)
top_genes_trend_plot
ggplotly(top_genes_trend_plot)
# Identify top 5 (or 10) genes overall
top_gene_list <- resfinder_fulldata %>%
count(gene, sort = TRUE) %>%
slice_head(n = 5) %>%
pull(gene)
# count those genes per year
top_genes_year <- resfinder_fulldata %>%
filter(gene %in% top_gene_list) %>%
count(collection_year, gene)
# visualize top genes
top_genes_trend_plot <-
ggplot(top_genes_year,
aes(x = collection_year,
y = n,
color = gene,
group = gene)) +
geom_line(size = 1) +
geom_point(size = 2) +
labs(
x = "Year of collection",
y = "Number of detections",
color = "AMR Gene"
) +
scale_color_viridis_d(option = "D") +
theme_minimal() +
theme(
panel.grid = element_blank(),
axis.text.x = element_text(angle = 45, hjust = 1),
plot.title = element_text(size = 12, face = "bold")
)
top_genes_trend_plot
ggplotly(top_genes_trend_plot)
# Identify top 5 (or 10) genes overall
top_gene_list <- resfinder_fulldata %>%
count(gene, sort = TRUE) %>%
slice_head(n = 5) %>%
pull(gene)
# count those genes per year
top_genes_year <- resfinder_fulldata %>%
filter(gene %in% top_gene_list) %>%
count(collection_year, gene)
# visualize top genes
top_genes_trend_plot <-
ggplot(top_genes_year,
aes(x = collection_year,
y = n,
color = gene,
group = gene)) +
geom_line(size = 1) +
geom_point(size = 2) +
labs(
title = "Figure 8: Top AMR Genes Across Collection Years",
x = "Year of collection",
y = "Number of detections",
color = "AMR Gene"
) +
scale_color_viridis_d(option = "D") +
theme_minimal() +
theme(
panel.grid = element_blank(),
axis.text.x = element_text(angle = 45, hjust = 1),
plot.title = element_text(size = 12, face = "bold")
)
top_genes_trend_plot
resfinder_fulldata
view(resfinder_fulldata)
amr_burden_plot
top_genes_plot
drug_long_plot
